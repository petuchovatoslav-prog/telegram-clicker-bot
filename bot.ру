import telebot
import random
import os
import time

# –¢–æ–∫–µ–Ω –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
TOKEN = os.environ.get('BOT_TOKEN')

bot = telebot.TeleBot(TOKEN)

# –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö
users = {}

# –ö–Ω–æ–ø–∫–∏
def main_menu():
    keyboard = telebot.types.InlineKeyboardMarkup(row_width=2)
    b1 = telebot.types.InlineKeyboardButton('ü™ô –ö–õ–ò–ö–ù–£–¢–¨', callback_data='click')
    b2 = telebot.types.InlineKeyboardButton('‚¨ÜÔ∏è –ê–ü–ì–†–ï–ô–î', callback_data='upgrade')
    b3 = telebot.types.InlineKeyboardButton('üé≤ –ú–û–ù–ï–¢–ö–ê', callback_data='coin')
    b4 = telebot.types.InlineKeyboardButton('üéÅ –ü–†–û–ú–û–ö–û–î', callback_data='promo')
    b5 = telebot.types.InlineKeyboardButton('üìä –ü–†–û–§–ò–õ–¨', callback_data='profile')
    keyboard.add(b1, b2, b3, b4, b5)
    return keyboard

# –°—Ç–∞—Ä—Ç
@bot.message_handler(commands=['start'])
def start(message):
    user_id = message.from_user.id
    if user_id not in users:
        users[user_id] = {
            'balance': 100,
            'power': 1,
            'clicks': 0,
            'level': 0,
            'total': 0,
            'promos': [],
            'wins': 0,
            'losses': 0
        }
    
    text = f"üëã –ü—Ä–∏–≤–µ—Ç, {message.from_user.first_name}!\nüí∞ –ë–∞–ª–∞–Ω—Å: 100\n‚ö° –°–∏–ª–∞ –∫–ª–∏–∫–∞: 1"
    bot.send_message(message.chat.id, text, reply_markup=main_menu())

# –ö–Ω–æ–ø–∫–∏
@bot.callback_query_handler(func=lambda call: True)
def handle_buttons(call):
    user_id = call.from_user.id
    user = users[user_id]
    
    if call.data == 'click':
        user['balance'] += user['power']
        user['clicks'] += 1
        user['total'] += 1
        
        text = f"‚úÖ +{user['power']} –º–æ–Ω–µ—Ç!\nüí∞ –ë–∞–ª–∞–Ω—Å: {user['balance']}\nüìä –ü—Ä–æ–≥—Ä–µ—Å—Å: {user['clicks']}/100"
        bot.edit_message_text(text, call.message.chat.id, call.message.message_id, reply_markup=main_menu())
    
    elif call.data == 'upgrade':
        if user['clicks'] >= 100:
            user['clicks'] = 0
            user['level'] += 1
            
            if user['level'] == 1: user['power'] = 2
            elif user['level'] == 2: user['power'] = 5
            elif user['level'] == 3: user['power'] = 10
            elif user['level'] == 4: user['power'] = 25
            elif user['level'] == 5: user['power'] = 50
            elif user['level'] == 6: user['power'] = 100
            elif user['level'] == 7: user['power'] = 250
            elif user['level'] == 8: user['power'] = 500
            elif user['level'] == 9: user['power'] = 1000
            elif user['level'] == 10: user['power'] = 2500
            elif user['level'] == 11: user['power'] = 5000
            elif user['level'] == 12: user['power'] = 10000
            elif user['level'] == 13: user['power'] = 25000
            elif user['level'] == 14: user['power'] = 50000
            elif user['level'] >= 15: user['power'] = 100000
            
            text = f"‚¨ÜÔ∏è –ê–ü–ì–†–ï–ô–î!\nüî® –£—Ä–æ–≤–µ–Ω—å: {user['level']}\n‚ö° –°–∏–ª–∞: {user['power']}"
            bot.edit_message_text(text, call.message.chat.id, call.message.message_id, reply_markup=main_menu())
        else:
            bot.answer_callback_query(call.id, f"‚ùå –ù—É–∂–Ω–æ –µ—â—ë {100 - user['clicks']} –∫–ª–∏–∫–æ–≤!", show_alert=True)
    
    elif call.data == 'coin':
        text = f"üé≤ –ú–û–ù–ï–¢–ö–ê 50/50\nüí∞ –ë–∞–ª–∞–Ω—Å: {user['balance']}\n\n–í—ã–±–µ—Ä–∏ —Å—Ç–æ—Ä–æ–Ω—É:"
        
        keyboard = telebot.types.InlineKeyboardMarkup()
        b1 = telebot.types.InlineKeyboardButton('ü¶Ö –û–†–Å–õ', callback_data='heads')
        b2 = telebot.types.InlineKeyboardButton('üí≤ –†–ï–®–ö–ê', callback_data='tails')
        b3 = telebot.types.InlineKeyboardButton('üîô –ù–ê–ó–ê–î', callback_data='back')
        keyboard.add(b1, b2, b3)
        
        bot.edit_message_text(text, call.message.chat.id, call.message.message_id, reply_markup=keyboard)
    
    elif call.data in ['heads', 'tails']:
        text = f"üí∞ –ù–∞–ø–∏—à–∏ —Å—É–º–º—É —Å—Ç–∞–≤–∫–∏ (–º–∞–∫—Å: {user['balance']}):"
        bot.edit_message_text(text, call.message.chat.id, call.message.message_id)
        bot.register_next_step_handler(call.message, process_bet, call.data)
    
    elif call.data == 'promo':
        text = "üéÅ –í–í–ï–î–ò –ü–†–û–ú–û–ö–û–î:\n\n–î–æ—Å—Ç—É–ø–Ω—ã–µ:\ntest - 1000 –º–æ–Ω–µ—Ç"
        bot.edit_message_text(text, call.message.chat.id, call.message.message_id)
        bot.register_next_step_handler(call.message, process_promo)
    
    elif call.data == 'profile':
        text = (f"üìä –ü–†–û–§–ò–õ–¨\n\n"
                f"üí∞ –ë–∞–ª–∞–Ω—Å: {user['balance']}\n"
                f"‚ö° –°–∏–ª–∞: {user['power']}\n"
                f"üî® –£—Ä–æ–≤–µ–Ω—å: {user['level']}\n"
                f"üìä –ü—Ä–æ–≥—Ä–µ—Å—Å: {user['clicks']}/100\n"
                f"üìà –ö–ª–∏–∫–æ–≤ –≤—Å–µ–≥–æ: {user['total']}\n"
                f"üé≤ –ú–æ–Ω–µ—Ç–∫–∞: {user['wins']}‚úÖ / {user['losses']}‚ùå")
        bot.edit_message_text(text, call.message.chat.id, call.message.message_id, reply_markup=main_menu())
    
    elif call.data == 'back':
        text = f"üëã –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é\nüí∞ –ë–∞–ª–∞–Ω—Å: {user['balance']}\n‚ö° –°–∏–ª–∞: {user['power']}"
        bot.edit_message_text(text, call.message.chat.id, call.message.message_id, reply_markup=main_menu())

# –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å—Ç–∞–≤–∫–∏
def process_bet(message, side):
    user_id = message.from_user.id
    user = users[user_id]
    
    try:
        bet = int(message.text)
        if bet > user['balance']:
            bot.send_message(message.chat.id, "‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –º–æ–Ω–µ—Ç!", reply_markup=main_menu())
            return
        
        user['balance'] -= bet
        result = random.choice(['heads', 'tails'])
        
        if result == side:
            user['balance'] += bet * 2
            user['wins'] += 1
            text = f"üéâ –ü–û–ë–ï–î–ê! +{bet * 2} –º–æ–Ω–µ—Ç"
        else:
            user['losses'] += 1
            text = f"üòû –ü–†–û–ò–ì–†–´–®! -{bet} –º–æ–Ω–µ—Ç"
        
        bot.send_message(message.chat.id, text, reply_markup=main_menu())
    except:
        bot.send_message(message.chat.id, "‚ùå –û—à–∏–±–∫–∞!", reply_markup=main_menu())

# –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø—Ä–æ–º–æ–∫–æ–¥–∞
def process_promo(message):
    user_id = message.from_user.id
    user = users[user_id]
    code = message.text.lower()
    
    if code == 'test' and code not in user['promos']:
        user['balance'] += 1000
        user['promos'].append(code)
        text = "‚úÖ –ü—Ä–æ–º–æ–∫–æ–¥ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω! +1000 –º–æ–Ω–µ—Ç"
    else:
        text = "‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –∏–ª–∏ —É–∂–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã–π –∫–æ–¥!"
    
    bot.send_message(message.chat.id, text, reply_markup=main_menu())

# –ó–∞–ø—É—Å–∫
print("–ë–æ—Ç –∑–∞–ø—É—â–µ–Ω!")
bot.infinity_polling()
